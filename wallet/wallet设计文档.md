[TOC]

# 概述

对hd钱包的解析


# 详细描述

根据已提供的文档,进行设计


# 设计规则

## 使用确定性钱包

- HD HD钱包种子(HD wallet seed)和HD钱包(HD wallet)
    - HD钱包种子:用来生成HD钱包中主私钥与主链码的短种子值。可以用助记词表示.
    - HD钱包:分层确定性钱包,即使用分层确定性(HD)密钥创建与传输协议(BIP-32)的钱包.

## 钱包标准

- 基于BIP-39的助记词标准
- 基于BIP-32的层级式确定性钱包标准
- 基于BIP-43的多用途层级式确定性钱包标准
- 基于BIP-44的多币种和多帐户钱包

## 设计钱包

设计钱包时,一个关键的考量就是权衡便利性与隐私性。
- 用户使用钱包中保存的私钥来签名交易,进而控制属于他们的以太币或代币。

# 业务设计

参考: https://github.com/miguelmota/go-ethereum-hdwallet

## 助记词生成

助记词生成的过程：先生成一个 128 位随机数，再加上对随机数做的校验 4 位，得到 132 位的一个数，然后按每 11 位做切分，这样就有了 12 个二进制数，然后用每个数去查 BIP39 定义的单词表，这样就得到 12 个助记词.
注: 过助记词可以获取相关联的多个私钥，但是通过其中一个私钥是不能获取助记词的，因此助记词≠私钥。

## 助记词推导出种子

PBKDF2 基本原理是通过一个为随机函数(例如 HMAC 函数)，把助记词明文和盐值作为输入参数，然后重复进行运算最终产生生成一个更长的（512 位）密钥种子。

## 种子构建钱包

这个种子构建一个确定性钱包并派生出它的密钥

## BIP44

货币类型: https://github.com/satoshilabs/slips/blob/master/slip- 0044.md

BIP44 的内容: 规定了子节点派生路径的范式
```string
    m / purpose' / coin_type' / account' / chain / address_index
    e.g. : m/44'/60'/0'/0/0

    解析:
    CKD: m: 使用 CKDpriv, M 则表示使用 CKDPub
    Purpose: 44' , hardened, 遵循哪个规范, 44 意味着 BIP44
    Coin: 60', hardened,指定当前分支支持的币种: 60 指代以太币, 61 指代以太坊经典币, 0指代比特币
    Account: 0' , hardened, 账户编号,钱包分成多个逻辑上的子账户,用于记账或管理。
    Chain: 0 , 对于非比特币币种都是 0,且必须是普通派生.
    (常量 0 用于外部(收款地址)，常量 1 用于内部（也称为找零地址）。外部用于在钱包外可见的地址（例如，用于接收付款）。内部链用于在钱包外部不可见的地址，用于返回交易变更。 (所以一般使用 0))
    Index: 0, 具体的账户节点(索引码)
```

## HD钱包一个重要特性

- 可以从父公钥派生子公钥, 而这个过程并不需要使用私钥。
    - 可以使用子私钥.
    - 可以使用对应的父公钥.
    - 因此,扩展的公钥可以用来生成HD钱包对应分支中所有的公钥。
- 安全性对比:
    - 这样的捷径可以用来创建非常安全的公钥,只在服务器或者应用中部署公钥以作为扩展公钥,而不再需要私钥。
    - 因为没有私钥,就不能花费任何转入这些地址的以太币。
- 消费子公钥地址上的币
    - 扩展私钥,可以用来生成地址对应的私钥并通过签名交易来花费这些地址上的代币。

## HD钱包增强派生算法由来

- 潜在风险
    - 访问扩展公钥并不能获得对应子私钥的访问。
    - 由于扩展公钥带有链码,如果子私钥被人获取或者泄漏,那么结合链码,就可以派生出所有其他的子私钥。
    - 通过泄露的子私钥和父链码,可以推算出所有的子私钥。
    - 最严重的: 子私钥和父链码结合在一起,可以推算出对应的父私钥。
- 增强派生算法出现
    - 打破了父公钥和子链码之间的关联。
    - 使用父私钥来生成子链码,而不是父公钥。
    - 通过链码无法推算父私钥及兄弟私钥。
- 使用场景
    - 想借助扩展公钥方便地派生一组子公钥.
- 增强派生在路径上的表示
    - 0 表示普通派生算法
    - 0’ 表示增强派生算法   

## HD钱包如何使用增强算法

- BIP-32使用了索引码。
    - 每一个索引码只需配合父密钥使用特定的子密钥派生方法,都可以产生一个不同的子密钥。
    - 索引码被分为两个范围:
        - 0和2^31-1之间的索引码(从0x0到0x7FFFFFFF)用于普通派生算法.
        - 2^31和2^32-1之间的索引码(从0x80000000到0xFFFFFFFF)用于增强派生算法。
    - 索引码小于2^31,则是普通子密钥,等于或者大于2^31,那么则是增强子密钥.
        - 0 表示普通索引码
        - 0’ 表示增强索引码 

## HD钱包结构体解析

```go
type Wallet struct {
    mnemonic  string   //助记词(可选)
    masterKey *hdkeychain.ExtendedKey   //主秘钥,包含主私钥和主链码
    seed      []byte  //种子
    url       accounts.URL //HD钱包的生成路径
    paths     map[common.Address]accounts.DerivationPath //每个账户的派生路径
    accounts  []accounts.Account  //保存所有当前钱包的账户
    stateLock sync.RWMutex   //钱包操作锁
}
```